谈谈RocketMQ的使用

​	RocketMQ是阿里开源的一款高性能、易使用的消息中间件，以队列的模型完成。它以生产者、消费者模式提供服务。生产者生产消息，消费者消费消息。RocketMQ对于消息的消费以订阅的方式完成，支持广播模式与集群模式。在官方文档的介绍中，RocketMQ支持亿级消息堆积。并且支持以下消息：事务消息、顺序消息、批量消息、定时消息、消息回溯等。

​	在对dubbo的使用理解中提过：网站架构有一个重要指标,可扩展性，而针对该指标目前最好的解决方案就是分布式系统服务：即将一整个大的系统服务按照业务需求逻辑与业务服务进行细分，将它们独立自成多个小的系统，降低系统整体的耦合度，提高系统整体的灵活性，使系统整体更容易扩展、维护、负载均衡；要想实现这些就必须要有通信技术实现多个业务与服务之间的调用、消息传递。

​	dubbo实现了基于接口的远程服务调用、服务的自动注册与发现、自动容错与服务调用的负载均衡，而RocketMQ则实现了分布式系统之间的消息传递。

​	RocketMQ基于生产者与、消费者模式工作。生产者向注册中心注册自己，提供注册中心的IP与身的组名；消费者选择指定注册中心，提供注册中心IP、消费模式、订阅的主体与需要消费的标签、消费者组名以及消息监听器。只需要如此简单的配置即可实现分布式系统消息的通信，因此RocketMQ是相当易用的。关于消息订阅的模式选择上可基于业务选择：集群模式表示一个消费者组中只能由一个消费者消费；广播模式则表示一个消费者组中可以由多个消费者消费。注意，此处我提到了一个消费者组，也就是说，即使配置了集群模式，不同的消费者组都可以接受消息。

​	RocketMQ的一些应用场景举例，以我实际使用过的一些应用场景来说。在电商网站中，商品详情页这类数据有着一个特点：数据变化小，数据量大。为此常常会使用模板技术生成静态页面，部署到服务器上，减轻数据访问压力同时提供更快的服务响应；当后台审核商品通过时，此时就应该生成静态页，但是这样有一个问题，业务的耦合度太高，此时可以使用RocketMQ来处理这类情况，通过发送消息通知由消息订阅放来完成工作达到解耦目的。另一个例子是现在的网站都提供各式各样的短信通知服务，通过第三方的短信发送服务提供商集成到自己的网站中提升用户的使用体验。不同的业务场景会有不同的短信模板，在各种的业务场景中调用发送短信的API当然可以，但是这样就不仅仅是耦合度高的问题了，还有大量的业务冗余，使用RocketMQ可以完美解决这类问题；第三方短信服务商允许提供预发送模板，通过配置生产与消费短信信息的消息队列，生产者只需提供用户手机号、短信模板名称、短信模板ID、需要发送的消息即可。

​	关于RocketMQ的事务消息、顺序消息、批量消息、定时消息、消息回溯等，此处做一些简单的总结。

​	事务消息：分布式系统中一个很麻烦的问题，以解释事务中最常用的转账案例来说，本地事务只需开启，然后执行业务逻辑再commit或rolback即可，但是在分布式系统中，转账的业务则是由多个子系统去实现了。为此生产者与消费者彼此之间必须知晓对方的程序执行状态。关于此问题的解决方案，通过单独的第三方表去实现：生产者这方的业务逻辑完成后对第三方表做插入，表示自己这边OK了，消费者接收消息，进行消费，执行业务逻辑，并将执行状态修改到数据表生产者发送过来的记录上，然后将消息发返回给生产者，如果消费者OK，那么就是彻底OK，如果不OK，则回滚。为此，必须保证事务消息能正确发送才进行commit操作，不然对数据库一顿操作，然后消息没发送岂不是很尴尬。至于剩下的那些消息，官方文档都有示例与解释，拿过来改改就可以使用了。